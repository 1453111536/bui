/**
 * @fileOverview Data \u547d\u540d\u7a7a\u95f4\u7684\u5165\u53e3\u6587\u4ef6
 * @ignore
 */define("bui/data",function(require){var e=require("bui/common"),t=e.namespace("Data");return e.mix(t,{Sortable:require("bui/data/sortable"),Proxy:require("bui/data/proxy"),AbstractStore:require("bui/data/abstractstore"),Store:require("bui/data/store"),Node:require("bui/data/node"),TreeStore:require("bui/data/treestore"),Bindable:require("bui/data/bindable")}),t}),define("bui/data/sortable",function(){var e="ASC",t="DESC",n=function(){};return n.ATTRS={compareFunction:{value:function(e,t){return e===undefined&&(e=""),t===undefined&&(t=""),BUI.isString(e)?e.localeCompare(t):e>t?1:e===t?0:-1}},sortField:{},sortDirection:{value:"ASC"},sortInfo:{getter:function(){var e=this,t=e.get("sortField");return{field:t,direction:e.get("sortDirection")}},setter:function(e){var t=this;t.set("sortField",e.field),t.set("sortDirection",e.direction)}}},BUI.augment(n,{compare:function(t,n,r,i){var s=this,o;return r=r||s.get("sortField"),i=i||s.get("sortDirection"),!r||!i?1:(o=i===e?1:-1,s.get("compareFunction")(t[r],n[r])*o)},getSortData:function(){},sortData:function(e,t,n){var r=this,n=n||r.getSortData();return BUI.isArray(e)&&(n=e,e=null),e=e||r.get("sortField"),t=t||r.get("sortDirection"),r.set("sortField",e),r.set("sortDirection",t),!e||!t?n:(n.sort(function(n,i){return r.compare(n,i,e,t)}),n)}}),n}),define("bui/data/proxy",function(require){var e=require("bui/data/sortable"),t=function(e){t.superclass.constructor.call(this,e)};t.ATTRS={},BUI.extend(t,BUI.Base),BUI.augment(t,{_read:function(e,t){},read:function(e,t,n){var r=this;n=n||r,r._read(e,function(e){t.call(n,e)})},update:function(e,t,n){}});var n=function(e){n.superclass.constructor.call(this,e)};n.ATTRS=BUI.mix(!0,t.ATTRS,{limitParam:{value:"limit"},startParam:{value:"start"},pageIndexParam:{value:"pageIndex"},dataType:{value:"json"},method:{value:"GET"},noCache:{value:!0},cache:{value:!1},url:{}}),BUI.extend(n,t),BUI.augment(n,{_processParams:function(e){var t=this,n=["start","limit","pageIndex"];$.each(n,function(n){var r=t.get(n+"Param");r!==n&&(e[r]=e[n],delete e[n])})},_read:function(e,t){var n=this;e=BUI.cloneObject(e),n._processParams(e),$.ajax({url:n.get("url"),type:n.get("method"),dataType:n.get("dataType"),data:e,cache:n.get("cache"),success:function(e){t(e)},error:function(e,n,r){var i={exception:{status:n,errorThrown:r,jqXHR:e}};t(i)}})}});var r=function(e){r.superclass.constructor.call(this,e)};return BUI.extend(r,t),BUI.mixin(r,[e]),BUI.augment(r,{_read:function(e,t){var n=this,r=e.pageable,i=e.start,s=e.sortField,o=e.sortDirection,u=e.limit,a=n.get("data"),f=[];n.sortData(s,o),u?(f=a.slice(i,i+u),t({rows:f,results:a.length})):(f=a.slice(i),t(f))}}),t.Ajax=n,t.Memery=r,t}),define("bui/data/abstractstore",function(require){function n(e){n.superclass.constructor.call(this,e),this._init()}var e=require("bui/common"),t=require("bui/data/proxy");return n.ATTRS={autoLoad:{value:!1},lastParams:{value:{}},params:{},proxy:{value:{}},url:{},events:{value:["acceptchanges","load","beforeload","beforeProcessLoad","add","exception","remove","update","localsort"]},data:{setter:function(e){var t=this,n=t.get("proxy");n.set?n.set("data",e):n.data=e,t.set("autoLoad",!0)}}},e.extend(n,e.Base),e.augment(n,{isStore:!0,_init:function(){var e=this;e.beforeInit(),e._initParams(),e._initProxy(),e._initData()},beforeInit:function(){},_initData:function(){var e=this,t=e.get("autoLoad");t&&e.load()},_initParams:function(){var t=this,n=t.get("lastParams"),r=t.get("params");e.mix(n,r)},_initProxy:function(){var e=this,n=e.get("url"),r=e.get("proxy");r instanceof t||(n&&(r.url=n),r.type==="ajax"||r.url?r=new t.Ajax(r):r=new t.Memery(r),e.set("proxy",r))},load:function(t){var n=this,r=n.get("proxy"),i=n.get("lastParams");e.mix(!0,i,n.getAppendParams(),t),n.fire("beforeload",{params:i}),t=e.cloneObject(i),r.read(i,function(e){n.onLoad(e,t)},n)},onLoad:function(e,t){var n=this;n.processLoad(e,t),n.afterProcessLoad(e,t)},processLoad:function(e,t){var n=this,r=n.get("hasErrorProperty");n.fire("beforeProcessLoad",e);if(e[r]||e.exception){n.onException(e);return}},afterProcessLoad:function(e,t){},onException:function(e){var t=this,n=t.get("errorProperty"),r={};e.exception?(r.type="exception",r[n]=e.exception):(r.type="error",r[n]=e[n]),t.fire("exception",r)},hasData:function(){},getAppendParams:function(){return{}}}),n}),define("bui/data/node",function(require){function t(t,n){var r={};return n?(e.each(t,function(e,t){var i=n[t]||t;r[i]=e}),r.record=t):r=t,r}function n(n,r){var i=this;n=t(n,r),e.mix(this,n)}var e=require("bui/common");return e.augment(n,{root:!1,leaf:!1,text:"",id:null,loaded:!1,path:null,parent:null,level:0,record:null,children:null,isNode:!0}),n}),define("bui/data/treestore",function(require){function r(e){r.superclass.constructor.call(this,e)}var e=require("bui/common"),t=require("bui/data/node"),n=require("bui/data/abstractstore");return r.ATTRS={root:{},map:{},dataProperty:{value:"nodes"}},e.extend(r,n),e.augment(r,{beforeInit:function(){this.initRoot()},_initData:function(){var e=this,t=e.get("autoLoad"),n=e.get("root");t&&(params=n.id?{id:n.id}:{},e.load(params))},initRoot:function(){var e=this,n=e.get("map"),r=e.get("root");r||(r={}),r.isNode||(r=new t(r,n)),r.path=[r.id],r.level=0,r.children&&e.setChildren(r,r.children),e.set("root",r)},add:function(n,r,i){var s=this,o=s.get("map"),u=r.children,a=n.children||[];return n.isNode||(n=new t(n,o)),n.parent=r,n.level=r.level+1,n.path=r.path.concat(n.id),r.leaf=!1,i=i==null?r.children.length:i,e.Array.addAt(u,n,i),s.setChildren(n,a),s.fire("add",{node:n,index:i}),n},remove:function(t){var n=t.parent;e.Array.remove(n.children,t),this.fire("remove",{node:t})},setChildren:function(t,n){var r=this;t.children=[];if(!n.length)return;e.each(n,function(e){r.add(e,t)})},findNode:function(t,n){var r=this;if(!n){var i=r.get("root");return i.id===t?i:r.findNode(t,i)}var s=n.children,o=null;return e.each(s,function(e){e.id===t?o=e:o=r.findNode(t,e);if(o)return!1}),o},contains:function(e,t){var n=this,r=n.findNode(e.id,t);return!!r},afterProcessLoad:function(t,n){var r=this,i=n.id,s=r.get("dataProperty"),o=r.findNode(i)||r.get("root");e.isArray(t)?r.setChildren(o,t):r.setChildren(o,t[s]),r.fire("load",{node:o,params:n})},hasData:function(){return this.get("root").children&&this.get("root").children.length!==0},isLoaded:function(e){return e.leaf||e.children.length},loadNode:function(e){var t=this;if(t.isLoaded(e))return;t.load({id:e.id})}}),r}),define("bui/data/store",function(require){function r(e,t){if(e<0)return;var n=t,r=n[e];return n.splice(e,1),r}function i(e,t){var n=BUI.Array.indexOf(e,t);n>=0&&r(n,t)}function s(e,t){return BUI.Array.indexOf(e,t)!==-1}var e=require("bui/data/proxy"),t=require("bui/data/abstractstore"),n=require("bui/data/sortable"),o=function(e){o.superclass.constructor.call(this,e)};return o.ATTRS={currentPage:{value:0},deletedRecords:{value:[]},errorProperty:{value:"error"},hasErrorProperty:{value:"hasError"},matchFunction:{value:function(e,t){return e==t}},modifiedRecords:{value:[]},newRecords:{value:[]},remoteSort:{value:!1},resultMap:{value:{}},root:{value:"rows"},rowCount:{value:0},totalProperty:{value:"results"},start:{value:0},pageSize:{}},BUI.extend(o,t),BUI.mixin(o,[n]),BUI.augment(o,{add:function(e,t,n){var r=this,i=r.getCount();r.addAt(e,i,t,n)},addAt:function(e,t,n,r){var s=this;r=r||s._getDefaultMatch(),BUI.isArray(e)||(e=[e]),$.each(e,function(e,o){if(!n||!s.contains(o,r))s._addRecord(o,e+t),s.get("newRecords").push(o),i(o,s.get("deletedRecords")),i(o,s.get("modifiedRecords"))})},contains:function(e,t){return this.findIndexBy(e,t)!==-1},find:function(e,t){var n=this,r=null,i=n.getResult();return $.each(i,function(n,i){if(i[e]===t)return r=i,!1}),r},findAll:function(e,t){var n=this,r=[],i=n.getResult();return $.each(i,function(n,i){i[e]===t&&r.push(i)}),r},findByIndex:function(e){return this.getResult()[e]},findIndexBy:function(e,t){var n=this,r=-1,i=n.getResult();return t=t||n._getDefaultMatch(),e===null||e===undefined?-1:($.each(i,function(n,i){if(t(e,i))return r=n,!1}),r)},findNextRecord:function(e){var t=this,n=t.findIndexBy(e);if(n>=0)return t.findByIndex(n+1);return},getCount:function(){return this.getResult().length},getTotalCount:function(){var e=this,t=e.get("resultMap"),n=e.get("totalProperty");return t[n]||0},getResult:function(){var e=this,t=e.get("resultMap"),n=e.get("root");return t[n]},hasData:function(){return this.getCount()!==0},setResult:function(t){var n=this,r=n.get("proxy");r instanceof e.Memery?(n.set("data",t),n.load({start:0})):n._setResult(t)},remove:function(e,t){var n=this,o=[];t=t||n._getDefaultMatch(),BUI.isArray(e)||(e=[e]),$.each(e,function(e,o){var e=n.findIndexBy(o,t),u=r(e,n.getResult());!s(u,n.get("newRecords"))&&!s(u,n.get("deletedRecords"))&&n.get("deletedRecords").push(u),i(u,n.get("newRecords")),i(u,n.get("modifiedRecords")),n.fire("remove",{record:u})})},sort:function(e,t){var n=this,r=n.get("remoteSort");r?(n.set("sortField",e),n.set("sortDirection",t),n.load(n.get("sortInfo"))):n._localSort(e,t)},sum:function(e,t){var n=this,r=t||n.getResult(),i=0;return BUI.each(r,function(t){var n=t[e];isNaN(n)||(i+=parseFloat(n))}),i},setValue:function(e,t,n){var r=e,i=this;r[t]=n,!s(r,i.get("newRecords"))&&!s(r,i.get("modifiedRecords"))&&i.get("modifiedRecords").push(r),i.fire("update",{record:r,field:t,value:n})},update:function(e,t){var n=e,r=this,i=null,o=null;t&&(i=r._getDefaultMatch(),o=r.findIndexBy(e,i),o>=0&&(n=r.getResult()[o])),n=BUI.mix(n,e),!s(n,r.get("newRecords"))&&!s(n,r.get("modifiedRecords"))&&r.get("modifiedRecords").push(n),r.fire("update",{record:n})},_addRecord:function(e,t){var n=this.getResult();t==undefined&&(t=n.length),n.splice(t,0,e),this.fire("add",{record:e,index:t})},_clearChanges:function(){var e=this;e.get("newRecords").splice(0),e.get("modifiedRecords").splice(0),e.get("deletedRecords").splice(0)},_getDefaultMatch:function(){return this.get("matchFunction")},_getPageParams:function(){var e=this,t=e.get("sortInfo"),n={start:e.get("start"),limit:e.get("pageSize"),pageIndex:e.get("pageIndex")};return e.get("remoteSort")&&BUI.mix(n,t),n},getAppendParams:function(){return this._getPageParams()},beforeInit:function(){this._setResult([])},_localSort:function(e,t){var n=this;n._sortData(e,t),n.fire("localsort")},_sortData:function(e,t,n){var r=this;n=n||r.getResult(),r.sortData(e,t,n)},afterProcessLoad:function(e,t){var n=this,r=n.get("root"),i=t.start,s=t.limit,o=n.get("totalProperty");BUI.isArray(e)?n._setResult(e):n._setResult(e[r],e[o]),n.set("start",i),s&&n.set("pageIndex",i/s),n.get("remoteSort")||n._sortData(),n.fire("load",{params:t})},_setResult:function(e,t){var n=this,r=n.get("resultMap");t=t||e.length,r[n.get("root")]=e,r[n.get("totalProperty")]=t,n._clearChanges()}}),o}),define("bui/data/bindable",function(){function e(){}return e.ATTRS={store:{},loadMask:{value:!1}},BUI.augment(e,{__bindUI:function(){var e=this,t=e.get("store"),n=e.get("loadMask");if(!t)return;t.on("beforeload",function(){n&&n.show&&n.show()}),t.on("load",function(t){e.onLoad(t),n&&n.hide&&n.hide()}),t.on("exception",function(t){e.onException(t)}),t.on("add",function(t){e.onAdd(t)}),t.on("remove",function(t){e.onRemove(t)}),t.on("update",function(t){e.onUpdate(t)}),t.on("localsort",function(t){e.onLocalSort(t)})},__syncUI:function(){var e=this,t=e.get("store");if(!t)return;t.get("autoLoad")&&t.hasData()&&e.onLoad()},onLoad:function(e){},onException:function(e){},onAdd:function(e){},onRemove:function(e){},onUpdate:function(e){},onLocalSort:function(e){}}),e});
