/*
Copyright 2011, KISSY UI Library v1.1.5
MIT Licensed
build time: Sep 11 10:29
*//**
 * AJBridge Class
 * @author kingfo oicuicu@gmail.com
 */define("bui/uploader/button/swfButton/ajbridge",function(e){function i(e){i.superclass.constructor.call(this,e)}var t=e("bui/common"),n=e("bui/swf"),r={};return t.mix(i,{eventHandler:function(e,t){var n=r[e];n&&n.__eventHandler(e,t)},augment:function(e,n){t.isString(n)&&(n=[n]);if(!t.isArray(n))return;t.each(n,function(t){e.prototype[t]=function(){try{return this.callSWF(t,Array.prototype.slice.call(arguments,0))}catch(e){this.fire("error",{message:e})}}})}}),t.extend(i,n),t.augment(i,{initializer:function(){i.superclass.initializer.call(this);var e=this,t=e.get("attrs"),n=t.id;r[n]=e,e.set("id",n)},__eventHandler:function(e,n){var r=this,i=n.type;n.id=e;switch(i){case"log":t.log(n.message);break;default:r.fire(i,n)}},destroy:function(){i.superclass.destroy.call(this);var e=this.get("id");r[e]&&delete r[e]}}),i.augment(i,["activate","getReady","getCoreVersion","setFileFilters","filter","setAllowMultipleFiles","multifile","browse","upload","uploadAll","cancel","getFile","removeFile","lock","unlock","setBtnMode","useHand","clear"]),t.AJBridge=i,i}),define("bui/uploader/button/filter",function(e){var t=e("bui/common"),n={msexcel:{type:"application/msexcel",ext:".xls,.xlsx"},msword:{type:"application/msword",ext:".doc,.docx"},gif:{type:"image/gif",ext:".gif"},jpeg:{type:"image/jpeg",ext:".jpg"},bmp:{type:"image/x-ms-bmp",ext:".bmp"},png:{type:"image/png",ext:".png"}};return{_getValueByDesc:function(e,r){var i=[];return t.isString(e)&&(e=e.split(",")),t.isArray(e)&&t.each(e,function(e,t){var s=n[e];s&&s[r]&&i.push(s[r])}),i.join(",")},getTypeByDesc:function(e){return this._getValueByDesc(e,"type")},getExtByDesc:function(e){return this._getValueByDesc(e,"ext")},getTypeByExt:function(e){var r=[];return t.isString(e)&&(e=e.split(",")),t.isArray(e)&&t.each(e,function(e){t.each(n,function(n,i){t.Array.indexOf(e,n.ext.split(","))>-1&&r.push(n.type)})}),r.join(",")}}}),define("bui/uploader/button/base",function(e){function a(e){return e.replace(/.*(\/|\\)/,"")}function f(e){var t=/\.[^\.]+/.exec(e)||[];return t.join("")}function l(e){var t=-1;do e/=1024,t++;while(e>99);return Math.max(e,.1).toFixed(1)+["KB","MB","GB","TB","PB","EB"][t]}function c(e){return e.id||t.guid("bui-uploader-file")}function h(){}function p(){}var t=e("bui/common"),n=t.Component,r=e("bui/uploader/button/filter"),i=t.prefix,s=i+"uploader",o=s+"-button",u=o+"-text";return h.ATTRS={},h.prototype={_uiSetButtonCls:function(e){var t=this,n=t.get("buttonCls"),r=t.get("el").find("."+o);r.addClass(n)},_uiSetText:function(e){var t=this,n=t.get("text"),r=t.get("el").find("."+u);r.text(n)}},p.ATTRS={elCls:{value:o},buttonCls:{view:!0},textCls:{view:!0},text:{view:!0,value:"\u4e0a\u4f20\u6587\u4ef6"},tpl:{view:!0,value:'<a href="javascript:void(0);" class="'+o+"-wrap"+'  {buttonCls}"><span class="'+u+' {textCls}">{text}</span></a>'},disabled:{value:!1,setter:function(e){return this.setDisabled(e),e}},multiple:{value:!0,setter:function(e){return this.setMultiple(e),e}},filter:{value:[],setter:function(e){return this.setFilter(e),e}}},p.prototype={getExtFileData:function(e){var n=a(e.name),r=l(e.size||0),i=f(e.name);return t.mix(e,{name:n,textSize:r,ext:i,id:c(e)}),e},setMultiple:function(){},setDisabled:function(){},getFilter:function(e){if(e){var t=[],n=[],i=[];return e.desc&&(t.push(e.desc),n.push(r.getExtByDesc(e.desc)),i.push(r.getTypeByDesc(e.desc))),e.ext&&(n.push(e.ext),i.push(r.getTypeByExt(e.ext))),e.type,{desc:t.join(","),ext:n.join(","),type:i.join(",")}}},setFilter:function(e){}},p.View=h,p}),define("bui/uploader/button/htmlButton",function(e){var t=e("bui/common"),n=t.Component,r=e("bui/uploader/button/base"),i=t.UA,s=n.View.extend([r.View],{},{ATTRS:{}}),o=n.Controller.extend([r],{renderUI:function(){var e=this;e._createInput()},bindUI:function(){},_createInput:function(){var e=this,n=e.get("el").find(".bui-uploader-button-wrap"),r=e.get("inputTpl"),s=e.get("name"),o;r=t.substitute(r,{name:s}),n.append(r),o=n.find("input"),i.ie==6&&o.css("fontSize","400px"),e._bindChangeHandler(o),e.set("fileInput",o),e.setMultiple(e.get("multiple")),e.setFilter(e.get("filter"))},_bindChangeHandler:function(e){var n=this;$(e).on("change",function(r){var i=$(this).val(),s=r.target.files,o=[];s?t.each(s,function(t){o.push(n.getExtFileData({name:t.name,type:t.type,size:t.size,file:t,input:e[0]}))}):o.push(n.getExtFileData({name:i,input:e[0]})),n.fire("change",{files:o,input:this}),n.reset()})},reset:function(){var e=this,t=e.get("fileInput");return t.parent().remove(),e.set("fileInput",null),e._createInput(),e},setMultiple:function(e){var t=this,n=t.get("fileInput");return!n||!n.length?!1:(e?n.attr("multiple","multiple"):n.removeAttr("multiple"),e)},setFilter:function(e){var t=this,n=t.get("fileInput"),r=t.getFilter(e);return!n||!n.length?!1:(r.type&&n.attr("accept",r.type),r)}},{ATTRS:{inputTpl:{view:!0,value:'<div class="file-input-wrapper"><input type="file" name="{name}" hidefocus="true" class="file-input" /></div>'},fileInput:{},name:{view:!0,value:"Filedata",setter:function(e){return e&&this.get("fileInput")&&$(this.get("fileInput")).attr("name",e),e}},xview:{value:s}}});return o}),define("bui/uploader/button/swfButton",function(e){var t=e("bui/common"),n=t.Component,r=e("bui/uploader/button/base"),i=e("bui/uploader/type/flash"),s=e("bui/uploader/button/swfButton/ajbridge"),o="bui-swf-uploader-wrapper-",u=n.View.extend([r.View],{},{ATTRS:{}}),a=n.Controller.extend([r],{renderUI:function(){var e=this;e._initSwfUploader()},bindUI:function(){var e=this,n=e.get("swfUploader");n.on("contentReady",function(r){e.fire("swfReady",{swfUploader:n}),n.on("fileSelect",function(n){var r=n.fileList,i=[];t.each(r,function(t){i.push(e.getExtFileData(t))}),e.fire("change",{files:i})}),e.setMultiple(e.get("multiple")),e.setFilter(e.get("filter"))})},_initSwfUploader:function(){var e=this,n=e.get("el").find(".bui-uploader-button-wrap"),r=e.get("flash"),i=e.get("swfTpl"),o;t.mix(r,{render:$(i).appendTo(n)}),o=new s(r),e.set("swfUploader",o)},setMultiple:function(e){var t=this,n=t.get("swfUploader");n&&n.multifile(e)},setFilter:function(e){var t=this,n=t.get("swfUploader"),r=t.getFilter(e);return n&&n.filter([e]),e}},{ATTRS:{swfUploader:{},flash:{value:{src:"http://a.tbcdn.cn/s/kissy/gallery/uploader/1.4/plugins/ajbridge/uploader.swf",params:{allowscriptaccess:"always",bgcolor:"#fff",wmode:"transparent",flashvars:{hand:!0,btn:!0,jsEntry:"BUI.AJBridge.eventHandler"}}}},swfTpl:{view:!0,value:'<div class="uploader-button-swf"></div>'},xview:{value:u}}});return a}),define("bui/uploader/type/base",function(e){function t(e){var n=this;t.superclass.constructor.call(n,e)}return t.ATTRS={file:{},url:{},data:{},fileDataName:{value:"Filedata"}},BUI.mix(t,{event:{START:"start",CANCEL:"cancel",SUCCESS:"success",ERROR:"error"}}),BUI.extend(t,BUI.Base,{upload:function(e){},stop:function(){},_processResponse:function(e){var t=this,n={};if(BUI.isString(e))try{n=BUI.JSON.parse(e)}catch(r){var i=e+"\uff0c\u8fd4\u56de\u7ed3\u679c\u96c6responseText\u683c\u5f0f\u4e0d\u5408\u6cd5\uff01";BUI.log(i),t.fire("error",{status:-1,result:{msg:i}})}else BUI.isObject(e)&&(n=t._fromUnicode(e));return BUI.log("\u670d\u52a1\u5668\u7aef\u8f93\u51fa\uff1a"+BUI.JSON.stringify(n)),n},_fromUnicode:function(e){function t(e){BUI.each(e,function(n,r){BUI.isObject(e[r])?t(e[r]):e[r]=BUI.isString(n)&&BUI.fromUnicode(n)||n})}return BUI.isObject(e)?(t(e),e):e}}),t}),define("bui/uploader/type/ajax",function(e){function i(e){var t=this;i.superclass.constructor.call(t,e)}var t="",n="[uploader-AjaxType]:",r=e("bui/uploader/type/base");return BUI.mix(i,{event:BUI.merge(r.event,{PROGRESS:"progress"})}),BUI.extend(i,r,{upload:function(e){if(!e||!e.file)return BUI.log(n+"upload()\uff0cfileData\u53c2\u6570\u6709\u8bef\uff01"),!1;var t=this;return t.set("file",e),t.fire(r.event.START,{file:e}),t._setFormData(),t._addFileData(e.file),t.send(),t},cancel:function(){var e=this,t=e.get("xhr"),r=e.get("file");return BUI.isObject(t)?(t.abort(),e.fire(i.event.CANCEL,{file:r}),e.set("file",null),e):(BUI.log(n+"cancel()\uff0cio\u503c\u9519\u8bef\uff01"),!1)},send:function(){var e=this,t=e.get("url"),n=e.get("formData"),r=e.get("file"),s=new XMLHttpRequest;return s.upload.addEventListener("progress",function(t){e.fire(i.event.PROGRESS,{loaded:t.loaded,total:t.total})}),s.onload=function(t){var n=e._processResponse(s.responseText);e.fire("complete",{result:n,file:r}),n&&n.status===1?e.fire(i.event.SUCCESS,{result:n,file:r}):e.fire(i.event.ERROR,{result:n,file:r})},s.open("POST",t,!0),n.append("type","ajax"),s.send(n),e._setFormData(),e.set("xhr",s),e},_setFormData:function(){var e=this;try{e.set("formData",new FormData),e._processData()}catch(t){BUI.log(n+"something error when reset FormData."),BUI.log(t,"dir")}},_processData:function(){var e=this,t=e.get("data"),n=e.get("formData");BUI.each(t,function(e,t){n.append(t,e)}),e.set("formData",n)},_addFileData:function(e){if(!e)return BUI.log(n+"_addFileData()\uff0cfile\u53c2\u6570\u6709\u8bef\uff01"),!1;var t=this,r=t.get("formData"),i=t.get("fileDataName");r.append(i,e),t.set("formData",r)}},{ATTRS:{formData:{},data:{},xhr:{}}}),i}),define("bui/uploader/type/flash",function(e){function r(e){var t=this;r.superclass.constructor.call(t,e),t.isHasCrossdomain()}var t="[uploader-FlashType]:",n=e("bui/uploader/type/base");return BUI.mix(r,{event:BUI.merge(n.event,{SWF_READY:"swfReady",PROGRESS:"progress"})}),BUI.extend(r,n,{_initSwfUploader:function(){var e=this,i=e.get("swfUploader");if(!i)return BUI.log(t+"swfUploader\u5bf9\u8c61\u4e3a\u7a7a\uff01"),!1;i.on("contentReady",function(t){e.fire(r.event.SWF_READY)}),i.on("uploadStart",function(t){var r=e.get("file");e.fire(n.event.START,{file:r})}),i.on("uploadProgress",function(n){BUI.mix(n,{loaded:n.bytesLoaded,total:n.bytesTotal}),BUI.log(t+"\u5df2\u7ecf\u4e0a\u4f20\u5b57\u8282\u6570\u4e3a\uff1a"+n.bytesLoaded),e.fire(r.event.PROGRESS,{loaded:n.loaded,total:n.total})}),i.on("uploadCompleteData",function(t){var n=e._processResponse(t.data);e.fire("complete",{result:n}),n&&n.status===1?e.fire(r.event.SUCCESS,{result:n}):e.fire(r.event.ERROR,{result:n}),e.set("file",null)}),i.on("uploadError",function(){e.set("file",file),e.fire(r.event.ERROR,{msg:ev.msg})})},upload:function(e){var t=this,n=t.get("swfUploader"),r=t.get("url"),i="POST",s=t.get("data"),o=t.get("fileDataName");if(!e)return;return t.set("file",e),n.upload(e.id,r,i,s,o),t},cancel:function(){var e=this,t=e.get("swfUploader"),n=e.get("file");return n&&(t.cancel(n.id),e.fire(r.event.CANCEL,{file:n}),e.set("file",null)),e},isHasCrossdomain:function(){var e=location.hostname;$.ajax({url:"http://"+e+"/crossdomain.xml",dataType:"xml",error:function(){BUI.log("\u7f3a\u5c11crossdomain.xml\u6587\u4ef6\u6216\u8be5\u6587\u4ef6\u4e0d\u5408\u6cd5\uff01")}})}},{ATTRS:{uploader:{setter:function(e){var t=this;if(e){var n=e.get("button");n.on("swfReady",function(e){t.set("swfUploader",e.swfUploader),t._initSwfUploader()})}}},url:{getter:function(e){var t=/^http/;if(!t.test(e)){var n=location.href,r=n.split("/"),i;i=BUI.Array.filter(r,function(e,t){return t<r.length-1}),e=i.join("/")+"/"+e}return e}},fileDataName:{value:"Filedata"},swfUploader:{},uploadingId:{}}}),r}),define("bui/uploader/queue",["bui/list"],function(e){var t=e("bui/common"),n=e("bui/list/simplelist"),r=t.prefix+"queue",i=r+"-item",s=n.extend({bindUI:function(){var e=this,t=e.get("el"),n=e.get("delCls");t.delegate("."+n,"click",function(t){var n=$(t.target).parent();e.removeItem(e.getItemByElement(n))})},updateFileStatus:function(e,n,r){var i=this,s=i.get("itemStatusFields");r=r||i.findElement(e),t.each(s,function(t,n){i.setItemStatus(e,n,!1,r)}),i.setItemStatus(e,n,!0,r),i.updateItem(e)}},{ATTRS:{itemCls:{value:r},itemTpl:{value:'<li><span data-url="{url}">{name}</span><div class="progress"><div class="bar" style="width:{loadedPercent}%"></div></div><div class="'+i+'-del">\u5220\u9664</div></li>'},itemCls:{value:i},delCls:{value:i+"-del"},itemStatusFields:{value:{wait:"wait",start:"start",progress:"progress",success:"success",cancel:"cancel",error:"error"}}}},{xclass:"queue"});return s}),define("bui/uploader/theme",function(e){var t=e("bui/common"),n=e("bui/uploader/queue"),r=e("bui/uploader/button/htmlButton"),i=e("bui/uploader/button/swfButton"),s={},o={_getButtonClass:function(e){var t=this;return e==="ajax"||e==="iframe"?r:i},createButton:function(e,n,r){var i=this,s=i.getTheme(e)||{},o=s.button||{},u=i._getButtonClass(s.type||r);return o=t.mix(o,n),new u(o)},createQueue:function(e,r){var i=this,s=i.getTheme(e)||{},o=s.queue||{};return o=t.mix(o,r),new n(o)},addTheme:function(e,t){s[e]=t},getTheme:function(e){return s[e]}};return o}),define("bui/uploader/uploader",function(e){var t=e("bui/common"),n=t.Component,r=e("bui/uploader/theme"),i=e("bui/uploader/type/ajax"),s=e("bui/uploader/type/flash"),o=window,u=n.View.extend({},{ATTRS:{}}),a=n.Controller.extend({initializer:function(){var e=this;e._initType(),e._initButton(),e._initQueue(),e._initUploaderType()},_getUploaderType:function(e){var t=this,n=t.get("types"),r;switch(e){case n.AJAX:r=i;break;case n.FLASH:r=s;break;case n.IFRAME:r=Iframe;break;default:}return r},_getUserConfig:function(e){var n=this.get("userConfig"),r={};return t.each(e,function(e){var t=n[e];t!==undefined&&(r[e]=t)}),r},_initButton:function(){var e=this,t=e.get("theme"),n=e.get("type"),i=e._getUserConfig(["render","text","buttonCls","name","multiple","filter"]),s=r.createButton(t,i,n);e.set("button",s)},_initQueue:function(){var e=this,t=e.get("queue"),n=e.get("theme");t||(t=r.createQueue(n,e._getUserConfig(["render"])),e.set("queue",t))},_initType:function(){var e=this,t=e.get("types"),n=e.get("type");n||(e.isSupportAjax()?e.set("type",t.AJAX):e.isSupportFlash()?e.set("type",t.FLASH):e.set("type",t.IFRAME))},_initUploaderType:function(){var e=this,t=e.get("type"),n=e._getUploaderType(t),r=new n(e._getUserConfig(["url","data"]));r.set("uploader",e),e.set("uploaderType",r)},_bindButton:function(){var e=this,n=e.get("button"),r=e.get("queue"),i=e.get("uploaderType");n.on("change",function(e){t.each(e.files,function(e){t.mix(e,{wait:!0})}),r.addItems(e.files)})},_bindQueue:function(){var e=this,t=e.get("queue");t.on("itemrendered itemupdated",function(n){var r=t.getItemsByStatus("wait");r&&r.length&&e.uploadFile(r[0])})},_bindUploaderCore:function(){var e=this,n=e.get("queue"),r=e.get("uploaderType");r.on("start",function(t){e.fire("start",{item:t.file})}),r.on("progress",function(r){var i=e.get("curUploadItem"),s=r.loaded,o=r.total;n.updateFileStatus(i,"progress"),t.mix(i,{loaded:s,total:o,loadedPercent:s*100/o}),e.fire("progress",{item:i,total:o,loaded:s})}),r.on("cancel",function(t){var r=e.get("curUploadItem");n.updateFileStatus(r,"cancel"),e.set("curUploadItem",null),e.fire("cancel",{curUploadItem:r})}),r.on("complete",function(t){e.fire("complete")}),r.on("success",function(r){var i=r.result,s=n.getItemsByStatus("wait"),o=e.get("curUploadItem");t.mix(o,{url:i.url}),n.updateFileStatus(o,"success"),e.set("curUploadItem",null),e.fire("success",{item:o}),e.uploadFiles()}),r.on("error",function(t){var r=e.get("curUploadItem");n.updateFileStatus(r,"error"),e.set("curUploadItem",null),e.fire("error",{item:r})})},isSupportAjax:function(){return!!o.FormData},isSupportFlash:function(){return!0},renderUI:function(){var e=this;e.get("button").render(),e.get("queue").render()},bindUI:function(){var e=this;e._bindButton(),e._bindQueue(),e._bindUploaderCore()},uploadFile:function(e){var t=this,n=t.get("queue"),r=t.get("uploaderType"),i=t.get("curUploadItem");e&&!i&&(t.set("curUploadItem",e),n.updateFileStatus(e,"start"),r.upload(e))},uploadFiles:function(){var e=this,t=e.get("queue"),n=t.getItemsByStatus("wait");n&&n.length&&e.uploadFile(n[0])}},{ATTRS:{types:{value:{AJAX:"ajax",FLASH:"flash",IFRAME:"iframe"}},type:{},theme:{},uploadStatus:{},xview:{value:u}}},{xclass:"uploader"});return a}),define("bui/uploader",function(e){var t=e("bui/common"),n=t.namespace("Uploader");return t.mix(n,{Uploader:e("bui/uploader/uploader"),Queue:e("bui/uploader/queue")}),n});
